<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üì§ Upload ·∫£nh & video</title>
<style>
  :root {
    --accent: #ff4d7e;
    --accent-2: #6ea8fe;
    --bg: #f3f7ff;
    --card: #fff;
    --muted: #6b7280;
  }
  body {
    margin:0;
    font-family: "Segoe UI", Roboto, Arial;
    background: linear-gradient(180deg,#eef6ff 0%, #fef6fb 100%);
    min-height:100vh;
    display:flex;
    align-items:flex-start;
    justify-content:center;
    padding:28px 12px;
  }
  .wrap {
    width:100%;
    max-width:920px;
    background: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.9));
    box-shadow: 0 10px 30px rgba(20,30,60,0.08);
    border-radius:14px;
    padding:22px;
  }
  h1 {
    margin:0 0 12px 0;
    font-size:22px;
    display:flex; gap:10px; align-items:center;
  }
  p.lead { margin: 6px 0 18px; color:var(--muted); }

  .controls {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom:16px;
  }

  .file-btn {
    display:inline-block;
    background: linear-gradient(90deg,var(--accent), #ff9bb3);
    color:white;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer;
    box-shadow: 0 6px 18px rgba(255,77,126,0.12);
    font-weight:600;
    text-decoration:none;
  }
  .file-list {
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
  }

  .btn {
    background:#2b6ef6;
    color:white;
    padding:10px 14px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-weight:600;
  }

  input[type="file"] { display:none; }

  .preview-grid {
    display:grid;
    grid-template-columns: repeat(auto-fill,minmax(150px,1fr));
    gap:12px;
    margin-top:18px;
  }

  .preview {
    background:var(--card);
    border-radius:12px;
    padding:8px;
    box-shadow:0 6px 14px rgba(20,30,60,0.04);
    display:flex;
    flex-direction:column;
    gap:8px;
    align-items:center;
  }

  .thumb {
    width:100%;
    height:110px;
    border-radius:8px;
    background:#f0f4ff;
    display:flex;
    align-items:center;
    justify-content:center;
    overflow:hidden;
  }

  .thumb img, .thumb video {
    width:100%;
    height:100%;
    object-fit:cover;
  }

  .meta {
    width:100%;
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:8px;
    font-size:13px;
    color:var(--muted);
  }

  .progress {
    width:100%;
    height:8px;
    background:#eee;
    border-radius:6px;
    overflow:hidden;
  }
  .bar {
    height:100%;
    width:0%;
    background: linear-gradient(90deg,var(--accent-2),var(--accent));
    transition: width .25s linear;
  }

  .note { color:var(--muted); font-size:13px; margin-top:10px; }

  .nav {
    display:flex; justify-content:flex-end; gap:8px; margin-top:12px;
  }

  a.link {
    text-decoration:none; color:#0b5cff; font-weight:600;
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>üì§ Upload ·∫£nh & video h·ªçc sinh</h1>
    <p class="lead">Ch·ªçn nhi·ªÅu file c√πng l√∫c. H·ªó tr·ª£ ·∫£nh v√† video. Sau khi t·∫£i l√™n s·∫Ω chuy·ªÉn v·ªÅ th∆∞ vi·ªán.</p>

    <div class="controls">
      <label class="file-btn" id="chooseBtn">Ch·ªçn file</label>
      <input id="fileInput" type="file" name="files[]" multiple accept="image/*,video/*">

      <button class="btn" id="startUpload">T·∫£i l√™n</button>

      <div style="flex:1"></div>

      <a class="link" href="/gallery">üìÅ Xem th∆∞ vi·ªán</a>
    </div>

    <div id="preview" class="preview-grid" aria-live="polite"></div>

    <div class="note">L∆∞u √Ω: kh√¥ng ch·ªçn file qu√° n·∫∑ng (>100MB) n·∫øu d√πng g√≥i free. N·∫øu tr√¨nh duy·ªát kh√¥ng cho ch·ªçn video, th·ª≠ d√πng Chrome tr√™n m√°y ho·∫∑c c·∫≠p nh·∫≠t tr√¨nh duy·ªát.</div>
  </div>

<script>
const fileInput = document.getElementById('fileInput');
const chooseBtn = document.getElementById('chooseBtn');
const preview = document.getElementById('preview');
const startUpload = document.getElementById('startUpload');

chooseBtn.addEventListener('click', ()=> fileInput.click());

let filesSelected = [];

fileInput.addEventListener('change', (e)=> {
  filesSelected = Array.from(e.target.files || []);
  renderPreviews();
});

function renderPreviews(){
  preview.innerHTML = '';
  if(filesSelected.length === 0){
    preview.innerHTML = `<div style="grid-column:1/-1;color:var(--muted)">Ch∆∞a c√≥ file n√†o ƒë∆∞·ª£c ch·ªçn.</div>`;
    return;
  }

  filesSelected.forEach((f, idx) => {
    const url = URL.createObjectURL(f);
    const isVideo = f.type.startsWith('video/');
    const card = document.createElement('div');
    card.className = 'preview';
    card.innerHTML = `
      <div class="thumb">${ isVideo ? `<video muted src="${url}"></video>` : `<img src="${url}">` }</div>
      <div class="meta">
        <div style="min-width:0;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${f.name}</div>
        <div style="color:var(--muted);font-size:12px">${(f.size/1024/1024).toFixed(1)}MB</div>
      </div>
      <div class="progress" aria-hidden="true"><div class="bar" id="bar-${idx}"></div></div>
    `;
    preview.appendChild(card);
  });
}

async function uploadFiles(){
  if(filesSelected.length === 0){
    alert('Ch∆∞a ch·ªçn file n√†o!');
    return;
  }

  startUpload.disabled = true;
  startUpload.textContent = 'ƒêang t·∫£i...';

  for(let i=0;i<filesSelected.length;i++){
    const f = filesSelected[i];
    await uploadSingle(f, i);
  }

  // xong -> chuy·ªÉn trang th∆∞ vi·ªán
  window.location.href = '/gallery';
}

function uploadSingle(file, idx){
  return new Promise((resolve, reject) => {
    const form = new FormData();
    // server c·ªßa m√†y ch·ªù "files[]", nh∆∞ng ƒë·ªÉ g·ª≠i t·ª´ng file v·∫´n d√πng same name
    form.append('files[]', file);

    const xhr = new XMLHttpRequest();
    xhr.open('POST','/upload',true);

    xhr.upload.onprogress = (e) => {
      if(e.lengthComputable){
        const pct = Math.round(e.loaded / e.total * 100);
        const bar = document.getElementById(`bar-${idx}`);
        if(bar) bar.style.width = pct + '%';
      }
    };

    xhr.onload = () => {
      if(xhr.status >= 200 && xhr.status < 300){
        resolve(xhr.responseText);
      } else {
        alert('Upload l·ªói file: ' + file.name + ' ‚Äî status ' + xhr.status);
        resolve(null); // ti·∫øp t·ª•c file kh√°c
      }
    };

    xhr.onerror = () => {
      alert('L·ªói m·∫°ng khi upload ' + file.name);
      resolve(null);
    };

    xhr.send(form);
  });
}

startUpload.addEventListener('click', uploadFiles);

// keyboard accessibility: Enter on chooseBtn
chooseBtn.addEventListener('keyup', (e)=> { if(e.key==='Enter') fileInput.click(); });

// initial empty preview
renderPreviews();
</script>
</body>
</html>
